<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BikeEase Ad Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 80%; margin-top: 50px; }
        .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .ad-output { background-color: #ffffff; border-left: 5px solid #007bff; padding: 20px; margin-top: 20px; border-radius: 5px; white-space: pre-wrap; }
        #progress-container { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card p-4">
            <h2 class="text-center mb-4">BikeEase Ad Generator</h2>
            <hr/>
            <p>Generate a custom advertisement for BikeEase based on the different models listed below. Or, take me to the <a href="/report">Summary</a> page</p>
            <form id="ad-form">
                <div class="mb-3">
                    <label for="model_name" class="form-label">Select Model</label>
                    <select class="form-select" id="model_name" name="model_name" required>
                        {% for model in models %}
                            <option value="{{ model }}" {% if selected_model == model %}selected{% endif %}>{{ model }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="specs" class="form-label">Bike Specifications</label>
                    <textarea class="form-control" id="specs" name="specs" rows="3" placeholder="e.g., Lightweight carbon frame, 21-speed Shimano gears..." required>{{ specs }}</textarea>
                </div>
                <div class="mb-3">
                    <label for="discount" class="form-label">Marketing Discount or Promo</label>
                    <input type="text" class="form-control" id="discount" name="discount" placeholder="e.g., 20% off for summer sale" value="{{ discount }}" required>
                </div>
                <div class="mb-3">
                    <label for="theme" class="form-label">Marketing Theme</label>
                    <input type="text" class="form-control" id="theme" name="theme" placeholder="e.g., Adventure, Urban Commuting" value="{{ theme }}" required>
                </div>
                <div class="d-grid">
                    <button type="submit" id="submit-btn" class="btn btn-primary">Generate Advertisement</button>
                </div>
            </form>

            <div id="progress-container" class="mt-4">
                <p id="status-text" class="text-muted mb-1">Processing...</p>
                <div class="progress">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
            </div>

            <div id="output-container" style="display: none;" class="mt-4">
                <h4>Generated Advertisement:</h4>
                <div id="ad-output" class="ad-output"></div>
            </div>
            
            <div id="error-container" style="display: none;" class="alert alert-danger mt-4"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('ad-form');
        const submitBtn = document.getElementById('submit-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('status-text');
        const outputContainer = document.getElementById('output-container');
        const adOutput = document.getElementById('ad-output');
        const errorContainer = document.getElementById('error-container');

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // Reset UI
            submitBtn.disabled = true;
            progressContainer.style.display = 'block';
            outputContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            adOutput.innerText = '';
            progressBar.style.width = '0%';
            progressBar.innerText = '0%';
            statusText.innerText = 'Starting...';

            const formData = new FormData(form);
            const params = new URLSearchParams(formData).toString();
            
            const eventSource = new EventSource(`/generate?${params}`);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    errorContainer.innerText = data.error;
                    errorContainer.style.display = 'block';
                    progressContainer.style.display = 'none';
                    submitBtn.disabled = false;
                    eventSource.close();
                    return;
                }

                if (data.status) {
                    statusText.innerText = data.status;
                }

                if (data.progress !== undefined) {
                    progressBar.style.width = `${data.progress}%`;
                    progressBar.innerText = `${data.progress}%`;
                }

                if (data.text) {
                    outputContainer.style.display = 'block';
                    adOutput.innerText = data.text;
                }

                if (data.progress === 100) {
                    submitBtn.disabled = false;
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('progress-bar-success');
                    progressBar.innerText = '';
                    statusText.innerText = 'Completed';
                    eventSource.close();
                }
            };

            eventSource.onerror = function() {
                errorContainer.innerText = "Connection lost or server error.";
                errorContainer.style.display = 'block';
                progressContainer.style.display = 'none';
                submitBtn.disabled = false;
                eventSource.close();
            };
        });
    </script>
</body>
</html>
